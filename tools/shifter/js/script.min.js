(()=>{"use strict";const e=document.querySelector("#main"),t=document.querySelector("#add"),n=document.querySelector("#clone"),r=document.querySelector("#export"),l=document.querySelector("#number"),c=document.getElementById("add-text-to-selected"),o=document.getElementById("break"),s=document.querySelector("#text"),a=document.getElementById("output"),d=document.getElementById("sum-table"),i=new Date,m=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,u=()=>document.getElementById("table"),h=e=>document.querySelector(e)?.value??"",p=e=>{const t=document.getElementById(e);return t&&0===t.children.length&&""===t.textContent.trim()},g=(e,t="")=>{const n=document.createElement(e);return n.innerHTML=t,n},v=()=>{const e=u();n.disabled=!(e&&e.querySelectorAll("tr").length>0)},x=e=>new Promise((t=>setTimeout(t,e))),b=()=>{A(),F(),L(),v()},f=e=>{e.preventDefault();const t=s.value;if(!t)return;const n=e.currentTarget;0===n.cellIndex||n.classList.contains("selected")||n.classList.add("selected"),y(n,t,o.checked),b()};const E=new class{constructor(e){this.namespace=e}setItem(e,t){localStorage.setItem(`${this.namespace}:${e}`,JSON.stringify(t))}getItem(e,t=null){const n=localStorage.getItem(`${this.namespace}:${e}`);return null!==n?JSON.parse(n):t}removeItem(e){localStorage.removeItem(`${this.namespace}:${e}`)}clear(){Object.keys(localStorage).filter((e=>e.startsWith(this.namespace+":"))).forEach((e=>localStorage.removeItem(e)))}}("table"),L=()=>{const e=u();if(!e)return;const t=Array.from(e.rows).map((e=>{const t=Array.from(e.cells),n=t.slice(0,-4).map((e=>({html:e.innerHTML,selected:e.classList.contains("selected")}))),r=t.slice(-4).map((e=>({html:e.innerHTML})));return n.concat(r)}));E.setItem("tableData",t)},y=(e,t,n=!1)=>{if(!t)return;const r=t.split(/\s+/).map((e=>e.trim())).filter(Boolean);let l=e.innerHTML;const c=l.replace(/<br\s*\/?>/gi," ");r.forEach((t=>{new RegExp(`\\b${t}\\b`,"i").test(c)||(n&&!e.dataset.breakAdded?(l+=(l?"<br>":"")+t,e.dataset.breakAdded="true"):(l+=(l?" ":"")+t,e.dataset.breakAdded=""))})),e.innerHTML=l,0===e.cellIndex||e.classList.contains("selected")||e.classList.add("selected"),b()},k=e=>{e.preventDefault();const t=e.currentTarget;0!==t.cellIndex&&(t.classList.toggle("selected"),b())},S=function(){const e=this.closest("tr");e&&(e.remove(),l.disabled=!p("table"),v(),b())};let T=0;const C=()=>{const e=s.value,t=Number(e[0]);return T+=t,T%t==0?1:0},I=e=>{const[,...t]=e.parentElement.children;return t.length-=4,t},w=function(){const e=I(this);if(e.length<2)return;const t=e[e.length-1].innerText;for(let t=e.length-1;t>0;t--)e[t].innerText=e[t-1].innerText;e[0].innerText=t,b()},N=function(){const e=I(this);if(e.length<2)return;const t=e[0].innerText;for(let t=0;t<e.length-1;t++)e[t].innerText=e[t+1].innerText;e[e.length-1].innerText=t,b()},A=()=>{const e=u();e&&Array.from(e.rows).forEach((e=>{const t=e.querySelectorAll("td.selected").length,n=e.querySelector('td[data-control="count"]');n&&(n.textContent=t)}))},M=e=>{const t=document.getElementById(e.toUpperCase());return t&&parseFloat(t.value)||0},F=()=>{const e=u();if(!e)return;let t=0;const n={},r=e.querySelectorAll("td");for(let e=0;e<r.length;e++){const l=r[e].innerHTML.toUpperCase().match(/\bC[1-5]\b/);if(l){const e=l[0],r=M(e);t=Number((t+r).toFixed(10)),n[e]=(n[e]||0)+1}}const l=Object.keys(n).map((e=>`${e} × ${n[e]} = ${M(e)*n[e]}`));a.innerHTML=`\n    <div class="section-title">Variables found: ${l||"None"}</div>\n    <div class="section-title">Total sum:${t}</div>`},$=(t,n)=>{let r=u();r||(r=document.createElement("table"),r.id="table",r.cellPadding="0",r.cellSpacing="0",e.appendChild(r));const l=document.createElement("tr"),c=document.createDocumentFragment(),o=g("td",(a=n)?a.charAt(0).toUpperCase()+a.slice(1):"");var a;o.addEventListener("dblclick",f),l.appendChild(o);const d=Number(t)>=28&&Number(t)<=31?Number(t):31,i=s.value;for(let e=1;e<=d;e++){let t=e<10?`0${e}`:e;i.includes("+")?t=C():i&&(t=i);const n=g("td",t);n.align="center",n.addEventListener("click",k),n.addEventListener("dblclick",f),l.appendChild(n)}[{text:"remove",control:"remove",handler:S},{text:"<",control:"prev",handler:N},{text:">",control:"next",handler:w},{text:"0",control:"count",handler:A}].forEach((({text:e,control:t,handler:n})=>{const r=g("td",e);r.dataset.control=t,r.addEventListener("click",n),l.appendChild(r)})),c.appendChild(l),r.appendChild(c),b()},q=(e,t)=>{e.nodeType||(e=document.getElementById(e));const n={worksheet:t||"Worksheet",table:(e=>(Array.from(e.rows).forEach((e=>{Array.from(e.cells).forEach((e=>{const t=e.textContent.trim().toLowerCase();["remove","<",">"].includes(t)?e.remove():(e.setAttribute("valign","top"),e.classList.contains("selected")&&e.setAttribute("bgcolor","#777777"),"count"===e.dataset.control&&e.setAttribute("bgcolor","#eeeeee"))}))})),e))(e.cloneNode(!0)).innerHTML},r=document.createElement("a");var l;r.download=(e=>{const t=new Date,n=e=>String(e).padStart(2,"0");return(e||"worksheet")+"-"+t.getFullYear()+"-"+n(t.getMonth()+1)+"-"+n(t.getDate())+"-"+n(t.getHours())+"-"+n(t.getMinutes())+"-"+Math.random().toString(36).slice(2,8)+".xls"})(t),r.href="data:application/vnd.ms-excel;base64,"+(e=>{const t=(new TextEncoder).encode(e);return btoa(String.fromCharCode(...t))})((l=n,'\n    <html xmlns:o="urn:schemas-microsoft-com:office:office"\n    xmlns:x="urn:schemas-microsoft-com:office:excel"\n    xmlns="http://www.w3.org/TR/REC-html40">\n    <head>\n    \x3c!--[if gte mso 9]>\n    <xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>\n    <x:Name>{worksheet}</x:Name>\n    <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>\n    </x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml>\n    <![endif]--\x3e\n    <meta charset="UTF-8"/>\n    </head><body><table border="1" style="border-collapse:collapse;">{table}</table></body></html>'.replace(/{(\w+)}/g,((e,t)=>l[t])))),r.click()};c.addEventListener("click",(()=>{const t=e.querySelectorAll(".selected");if(!t.length)return;const n=s.value,r=o.checked;t.forEach((e=>y(e,n,r))),b()})),r.addEventListener("click",(()=>q("table"))),d?.addEventListener("click",F),t.addEventListener("click",(()=>{const e=h("#number"),t=p("table")?m:h("#name");$(e,t),l.disabled=!0,v(),b()})),["C1","C2","C3","C4","C5"].forEach((e=>{const t=document.getElementById(e);if(t){const n=()=>{s.value=e.toUpperCase()};t.addEventListener("click",n);const r=t.closest("label");r&&r.addEventListener("click",(e=>{e.preventDefault(),n(),b()})),t.addEventListener("input",b),t.addEventListener("change",b)}})),n.addEventListener("click",(function(){const e=u();if(!e)return;const t=e.getElementsByTagName("tr");if(!t.length)return;const n=t[t.length-1].cloneNode(!0);n.querySelectorAll("td").forEach((e=>{const t=e.textContent.trim().toLowerCase();0!==e.cellIndex?(["remove","<",">"].includes(t)||"count"===e.dataset.control||(e.addEventListener("click",k),e.addEventListener("dblclick",f)),"remove"===t?e.addEventListener("click",S):"<"===t?e.addEventListener("click",N):">"===t&&e.addEventListener("click",w)):e.addEventListener("dblclick",f)})),e.appendChild(n),b()}));const D=()=>{const e=u();e&&e.addEventListener("contextmenu",(e=>{const t=e.target.closest("td");t&&!t.dataset.control&&(e.preventDefault(),t.innerHTML="",t.classList.remove("selected"),t.dataset.breakAdded="",b())}))};document.addEventListener("DOMContentLoaded",(()=>{const t=E.getItem("tableData",null);t&&t.length>0?((()=>{const e=E.getItem("tableData",[]);e.length&&(e.forEach((e=>{const t=e[0]?.text||"",n=e.length-5;$(n,t);const r=u(),l=r.rows[r.rows.length-1];e.forEach(((e,t)=>{l.cells[t].innerHTML=e.html||"",t>0&&t<l.cells.length-4&&e.selected&&l.cells[t].classList.add("selected")}))})),b())})(),D()):""===e.innerHTML.trim()&&($(h("#number"),m),l.disabled=!0,D()),b()}));const B=(e,t,n)=>{const r=Number(e),l=Number(t)||1,c=Math.max((e.toString().split(".")[1]||"").length,(t.toString().split(".")[1]||"").length);return Number(("inc"===n?r+l:r-l).toFixed(c))},H={min:0,max:100,step:0,value:0,set number(e){"number"==typeof e&&(e>this.max||e<this.min||(this.value=e))},get number(){return this.value}};Object.seal(H);let W=!1;const O=document.querySelectorAll('input[type="number"]');async function U(e){W||(W=!0,e?.classList?.add("saved"),await x(500),(()=>{const e=Array.from(O,(e=>e.value));E.setItem("counterValues",e)})(),e?.classList?.remove("saved"),W=!1)}const j=async e=>{e.classList.add("max"),await x(200),e.classList.remove("max")},R=e=>{const t=e.target;if("BUTTON"!==t.tagName)return;const n=t.parentElement.querySelector('input[type="number"]');if(n){if(H.number=parseFloat(n.value),H.step=parseFloat(n.step)||.1,"—"===t.textContent){const e=B(n.value,n.step||H.step,"dec");if(!(e>=(parseFloat(n.min)||H.min)))return j(t);n.value=e}if("+"===t.textContent){const e=B(n.value,n.step||H.step,"inc");if(!(e<=(parseFloat(n.max)||H.max)))return j(t);n.value=e}U(t.parentElement)}},V=e=>{const t=e.target;let n=parseFloat(t.value);const r=parseFloat(t.min)||H.min,l=parseFloat(t.max)||H.max;(isNaN(n)||n<r)&&(n=r),n>l&&(n=l);const c=parseFloat(t.step)||H.step,o=Math.max((c.toString().split(".")[1]||"").length,(n.toString().split(".")[1]||"").length);t.value=Number(n.toFixed(o)),U(t.parentElement)},J=E.getItem("counterValues",[]);O.forEach(((e,t)=>{e.value=J&&void 0!==J[t]?J[t]:e.value||e.min||.1,e.parentElement?.addEventListener("click",R),e.addEventListener("change",V)}))})();

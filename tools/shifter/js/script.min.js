(()=>{"use strict";const e=document.querySelector("#main"),t=document.querySelector("#add"),n=document.querySelector("#clone"),r=document.querySelector("#export"),l=document.querySelector("#number"),c=document.getElementById("add-text-to-selected"),o=document.getElementById("break"),s=document.querySelector("#text"),a=document.getElementById("output"),d=document.getElementById("sum-table"),i=new Date,m=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,u=()=>document.getElementById("table"),h=e=>document.querySelector(e)?.value??"",p=e=>{const t=document.getElementById(e);return t&&0===t.children.length&&""===t.textContent.trim()},g=(e,t="")=>{const n=document.createElement(e);return n.innerHTML=t,n},v=()=>{const e=u();n.disabled=!(e&&e.querySelectorAll("tr").length>0)},x=e=>new Promise((t=>setTimeout(t,e))),b=e=>{e.preventDefault();const t=s.value;if(!t)return;const n=e.currentTarget;0===n.cellIndex||n.classList.contains("selected")||n.classList.add("selected"),L(n,t,o.checked),N(),$(),E()};const f=new class{constructor(e){this.namespace=e}setItem(e,t){localStorage.setItem(`${this.namespace}:${e}`,JSON.stringify(t))}getItem(e,t=null){const n=localStorage.getItem(`${this.namespace}:${e}`);return null!==n?JSON.parse(n):t}removeItem(e){localStorage.removeItem(`${this.namespace}:${e}`)}clear(){Object.keys(localStorage).filter((e=>e.startsWith(this.namespace+":"))).forEach((e=>localStorage.removeItem(e)))}}("table"),E=()=>{const e=u();if(!e)return;const t=Array.from(e.rows).map((e=>{const t=Array.from(e.cells),n=t.slice(0,-4).map((e=>({html:e.innerHTML,selected:e.classList.contains("selected")}))),r=t.slice(-4).map((e=>({html:e.innerHTML})));return n.concat(r)}));f.setItem("tableData",t)},L=(e,t,n=!1)=>{if(!t)return;const r=t.split(/\s+/).map((e=>e.trim())).filter(Boolean);let l=e.innerHTML;r.forEach((t=>{new RegExp(`\\b${t}\\b`,"i").test(l)||(n&&!e.dataset.breakAdded?(l+=(l?"<br>":"")+t,e.dataset.breakAdded="true"):(l+=(l?" ":"")+t,e.dataset.breakAdded=""))})),e.innerHTML=l,0===e.cellIndex||e.classList.contains("selected")||e.classList.add("selected"),N(),$(),E()},y=e=>{e.preventDefault();const t=e.currentTarget;0!==t.cellIndex&&(t.classList.toggle("selected"),N(),$(),E())},k=function(){const e=this.closest("tr");e&&(e.remove(),l.disabled=!p("table"),v(),N(),E())};let S=0;const T=()=>{const e=s.value,t=Number(e[0]);return S+=t,S%t==0?1:0},C=e=>{const[,...t]=e.parentElement.children;return t.length-=4,t},I=function(){const e=C(this);if(e.length<2)return;const t=e[e.length-1].innerText;for(let t=e.length-1;t>0;t--)e[t].innerText=e[t-1].innerText;e[0].innerText=t},w=function(){const e=C(this);if(e.length<2)return;const t=e[0].innerText;for(let t=0;t<e.length-1;t++)e[t].innerText=e[t+1].innerText;e[e.length-1].innerText=t},N=()=>{const e=u();e&&Array.from(e.rows).forEach((e=>{const t=e.querySelectorAll("td.selected").length,n=e.querySelector('td[data-control="count"]');n&&(n.textContent=t)}))},A=e=>{const t=document.getElementById(e.toUpperCase());return t&&parseFloat(t.value)||0},$=()=>{const e=u();if(!e)return;let t=0;const n={},r=e.querySelectorAll("td");for(let e=0;e<r.length;e++){const l=r[e].innerHTML.toUpperCase().match(/\bC[1-5]\b/);if(l){const e=l[0],r=A(e);t=Number((t+r).toFixed(10)),n[e]=(n[e]||0)+1}}const l=Object.keys(n).map((e=>`${e} × ${n[e]} = ${A(e)*n[e]}`));a.innerHTML=`\n    <div class="section-title">Variables found: ${l||"None"}</div>\n    <div class="section-title">Total sum:${t}</div>`},q=(t,n)=>{let r=u();r||(r=document.createElement("table"),r.id="table",r.cellPadding="0",r.cellSpacing="0",e.appendChild(r));const l=document.createElement("tr"),c=document.createDocumentFragment(),o=g("td",(a=n)?a.charAt(0).toUpperCase()+a.slice(1):"");var a;o.addEventListener("dblclick",b),l.appendChild(o);const d=Number(t)>=28&&Number(t)<=31?Number(t):31,i=s.value;for(let e=1;e<=d;e++){let t=e<10?`0${e}`:e;i.includes("+")?t=T():i&&(t=i);const n=g("td",t);n.align="center",n.addEventListener("click",y),n.addEventListener("dblclick",b),l.appendChild(n)}[{text:"remove",control:"remove",handler:k},{text:"<",control:"prev",handler:w},{text:">",control:"next",handler:I},{text:"0",control:"count",handler:N}].forEach((({text:e,control:t,handler:n})=>{const r=g("td",e);r.dataset.control=t,r.addEventListener("click",n),l.appendChild(r)})),c.appendChild(l),r.appendChild(c)},F=(e,t)=>{e.nodeType||(e=document.getElementById(e));const n={worksheet:t||"Worksheet",table:(e=>(Array.from(e.rows).forEach((e=>{Array.from(e.cells).forEach((e=>{const t=e.textContent.trim().toLowerCase();["remove","<",">"].includes(t)?e.remove():(e.setAttribute("valign","top"),e.classList.contains("selected")&&e.setAttribute("bgcolor","#777777"),"count"===e.dataset.control&&e.setAttribute("bgcolor","#eeeeee"))}))})),e))(e.cloneNode(!0)).innerHTML};var r;window.location.href="data:application/vnd.ms-excel;base64,"+(e=>{const t=(new TextEncoder).encode(e);return btoa(String.fromCharCode(...t))})((r=n,'\n    <html xmlns:o="urn:schemas-microsoft-com:office:office"\n    xmlns:x="urn:schemas-microsoft-com:office:excel"\n    xmlns="http://www.w3.org/TR/REC-html40">\n    <head>\n    \x3c!--[if gte mso 9]>\n    <xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>\n    <x:Name>{worksheet}</x:Name>\n    <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>\n    </x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml>\n    <![endif]--\x3e\n    <meta charset="UTF-8"/>\n    </head><body><table border="1" style="border-collapse:collapse;">{table}</table></body></html>'.replace(/{(\w+)}/g,((e,t)=>r[t]))))};c.addEventListener("click",(()=>{const t=e.querySelectorAll(".selected");if(!t.length)return;const n=s.value,r=o.checked;t.forEach((e=>L(e,n,r)))})),r.addEventListener("click",(()=>F("table"))),d?.addEventListener("click",$),t.addEventListener("click",(()=>{const e=h("#number"),t=p("table")?m:h("#name");q(e,t),l.disabled=!0,v()})),["C1","C2","C3","C4","C5"].forEach((e=>{const t=document.getElementById(e);if(t){const n=()=>{s.value=e.toUpperCase()};t.addEventListener("click",n);const r=t.closest("label");r&&r.addEventListener("click",(e=>{e.preventDefault(),n()}));const l=()=>{$(),N(),E()};t.addEventListener("input",l),t.addEventListener("change",l)}})),n.addEventListener("click",(function(){const e=u();if(!e)return;const t=e.getElementsByTagName("tr");if(!t.length)return;const n=t[t.length-1].cloneNode(!0);n.querySelectorAll("td").forEach((e=>{const t=e.textContent.trim().toLowerCase();0!==e.cellIndex?(["remove","<",">"].includes(t)||"count"===e.dataset.control||(e.addEventListener("click",y),e.addEventListener("dblclick",b)),"remove"===t?e.addEventListener("click",k):"<"===t?e.addEventListener("click",w):">"===t&&e.addEventListener("click",I)):e.addEventListener("dblclick",b)})),e.appendChild(n)}));const M=()=>{const e=u();e&&e.addEventListener("contextmenu",(e=>{const t=e.target.closest("td");t&&!t.dataset.control&&(e.preventDefault(),t.innerHTML="",t.classList.remove("selected"),t.dataset.breakAdded="",N(),$(),E())}))};document.addEventListener("DOMContentLoaded",(()=>{const t=f.getItem("tableData",null);t&&t.length>0?((()=>{const e=f.getItem("tableData",[]);e.length&&(e.forEach((e=>{const t=e[0]?.text||"",n=e.length-5;q(n,t);const r=u(),l=r.rows[r.rows.length-1];e.forEach(((e,t)=>{l.cells[t].innerHTML=e.html||"",t>0&&t<l.cells.length-4&&e.selected&&l.cells[t].classList.add("selected")}))})),N(),$())})(),M(),$()):""===e.innerHTML.trim()&&(q(h("#number"),m),l.disabled=!0,M(),$())}));const B=(e,t,n)=>{const r=Number(e),l=Number(t)||1,c=Math.max((e.toString().split(".")[1]||"").length,(t.toString().split(".")[1]||"").length);return Number(("inc"===n?r+l:r-l).toFixed(c))},D={min:.1,max:100,step:.1,value:0,set number(e){"number"==typeof e&&(e>this.max||e<this.min||(this.value=e))},get number(){return this.value}};Object.seal(D);let H=!1;const W=document.querySelectorAll('input[type="number"]');async function O(e){H||(H=!0,e?.classList?.add("saved"),await x(500),(()=>{const e=Array.from(W,(e=>e.value));f.setItem("counterValues",e)})(),e?.classList?.remove("saved"),H=!1)}const U=async e=>{e.classList.add("max"),await x(200),e.classList.remove("max")},j=e=>{const t=e.target;if("BUTTON"!==t.tagName)return;const n=t.parentElement.querySelector('input[type="number"]');if(n){if(D.number=parseFloat(n.value),D.step=parseFloat(n.step)||.1,"—"===t.textContent){const e=B(n.value,n.step||D.step,"dec");if(!(e>=(parseFloat(n.min)||D.min)))return U(t);n.value=e}if("+"===t.textContent){const e=B(n.value,n.step||D.step,"inc");if(!(e<=(parseFloat(n.max)||D.max)))return U(t);n.value=e}O(t.parentElement)}},R=e=>{const t=e.target;let n=parseFloat(t.value);const r=parseFloat(t.min)||D.min,l=parseFloat(t.max)||D.max;(isNaN(n)||n<r)&&(n=r),n>l&&(n=l);const c=parseFloat(t.step)||D.step,o=Math.max((c.toString().split(".")[1]||"").length,(n.toString().split(".")[1]||"").length);t.value=Number(n.toFixed(o)),O(t.parentElement)},V=f.getItem("counterValues",[]);W.forEach(((e,t)=>{e.value=V&&void 0!==V[t]?V[t]:e.value||e.min||.1,e.parentElement?.addEventListener("click",j),e.addEventListener("change",R)}))})();

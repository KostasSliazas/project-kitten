(()=>{"use strict";const e=document.querySelector("#main"),t=document.querySelector("#add"),n=document.querySelector("#clone"),r=document.querySelector("#export"),l=document.querySelector("#number"),a=document.getElementById("add-text-to-selected"),s=document.getElementById("break"),c=document.getElementById("name"),o=document.querySelector("#text"),i=document.getElementById("sum-table"),d=document.getElementById("export-json"),m=document.getElementById("import-json"),u=document.getElementById("import-file"),p=new Date,h=`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,"0")}-${String(p.getDate()).padStart(2,"0")}`,g=e=>new Promise((t=>setTimeout(t,e)));const v=new class{constructor(e){this.namespace=e}setItem(e,t){localStorage.setItem(`${this.namespace}:${e}`,JSON.stringify(t))}getItem(e,t=null){const n=localStorage.getItem(`${this.namespace}:${e}`);return null!==n?JSON.parse(n):t}removeItem(e){localStorage.removeItem(`${this.namespace}:${e}`)}}("table"),f=(e="export",t="json")=>{const n=new Date,r=e=>String(e).padStart(2,"0");return`${e}-${n.getFullYear()+"-"+r(n.getMonth()+1)+"-"+r(n.getDate())+"-"+r(n.getHours())+"-"+r(n.getMinutes())+"-"+r(n.getSeconds())}-${Math.random().toString(36).substring(2,8).toUpperCase()}.${t}`},E=()=>document.getElementById("table"),x=(e,t="")=>{const n=document.createElement(e);return n.innerHTML=t,n},b=e=>{const t=document.getElementById(e.toUpperCase());return t&&parseFloat(t.value)||0},L=()=>{k(),M()},y=e=>{const t=e.querySelectorAll("td"),n=t.length-4;let r=0,l=0;for(let e=0;e<n;e++){const n=t[e];n.classList.contains("selected")&&l++;const a=(n.innerHTML||"").replace(/<br\s*\/?>/gi," ").toUpperCase().match(/\bC[1-5]\b/g);if(a)for(let e=0;e<a.length;e++)r+=b(a[e])}const a=e.querySelector('td[data-control="count"]')||t[t.length-1];a&&(a.textContent=`${l}/${r}`)},k=()=>{const e=E();e&&Array.from(e.rows).forEach(y)},S=(e,t,n=!1)=>{if(!t)return;const r=t.split(/\s+/).map((e=>e.trim())).filter(Boolean);let l=e.innerHTML;const a=l.replace(/<br\s*\/?>/gi," ");r.forEach((t=>{new RegExp(`\\b${t}\\b`,"i").test(a)||(n&&!e.dataset.breakAdded?(l+=(l?"<br>":"")+t,e.dataset.breakAdded="true"):(l+=(l?" ":"")+t,e.dataset.breakAdded=""))})),e.innerHTML=l,0===e.cellIndex||e.classList.contains("selected")||e.classList.add("selected"),L()},A=e=>{const t=e.currentTarget;if(!t||0===t.cellIndex)return;const n=t.parentElement.querySelectorAll("td");t.cellIndex>=n.length-4||(t.classList.toggle("selected"),L())},I=e=>{const t=e.currentTarget,n=t.parentElement.querySelectorAll("td");t.cellIndex>=n.length-4||S(t,o.value,s.checked)},N=function(){const e=this.closest("tr");e&&(e.remove(),L())},w=function(){const e=this.closest("tr");if(!e)return;const t=e.querySelectorAll("td"),n=Array.prototype.slice.call(t,1,-4);if(n.length<2)return;const r=n[0].innerHTML,l=n[0].className;for(let e=0;e<n.length-1;e++)n[e].innerHTML=n[e+1].innerHTML,n[e].className=n[e+1].className;const a=n.length-1;n[a].innerHTML=r,n[a].className=l,L()},T=function(){const e=this.closest("tr");if(!e)return;const t=e.querySelectorAll("td"),n=Array.prototype.slice.call(t,1,-4);if(n.length<2)return;const r=n.length-1,l=n[r].innerHTML,a=n[r].className;for(let e=r;e>0;e--)n[e].innerHTML=n[e-1].innerHTML,n[e].className=n[e-1].className;n[0].innerHTML=l,n[0].className=a,L()},C=(t,n)=>{let r=E();r||(r=document.createElement("table"),r.id="table",r.cellPadding="0",r.cellSpacing="0",e.appendChild(r));const l=document.createElement("tr"),a=x("td",n||"");a.addEventListener("dblclick",I),l.appendChild(a);for(let e=1;e<=t;e++){let t=o.value?o.value:e;const n=x("td",t);n.align="center",n.style.textAlign="center",n.addEventListener("click",A),n.addEventListener("dblclick",I),l.appendChild(n)}[{text:"remove",control:"remove",handler:N},{text:"<",control:"prev",handler:w},{text:">",control:"next",handler:T},{text:"0",control:"count",handler:null}].forEach((e=>{const t=x("td",e.text);t.dataset.control=e.control,e.handler&&t.addEventListener("click",e.handler),l.appendChild(t)})),r.appendChild(l),L()},M=()=>{const e=E();if(!e)return;const t=Array.from(e.rows).map((e=>{const t=Array.from(e.cells);return t.slice(0,t.length-4).map((e=>({html:e.innerHTML,selected:e.classList.contains("selected")})))}));v.setItem("tableData",t)},H=()=>{const e=v.getItem("tableData",[]),t=E();t&&t.remove(),Array.isArray(e)&&0!==e.length&&(e.forEach((e=>{const t=e.length,n=e[0]?.html||"";C(Math.max(0,t-1),n.value||h);const r=E(),l=r.rows[r.rows.length-1];for(let n=0;n<t;n++){const t=e[n];if(!t)continue;const r=l.cells[n];r&&(r.innerHTML=t.html||"",t.selected?r.classList.add("selected"):r.classList.remove("selected"))}})),L())};d?.addEventListener("click",(()=>{const e=E();if(!e)return;const t=Array.from(e.rows).map((e=>Array.from(e.cells).slice(0,-4).map((e=>({html:e.innerHTML,selected:e.classList.contains("selected")}))))),n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(n),l=document.createElement("a");l.href=r,l.download=f(c.value||"data-table","json"),l.click(),URL.revokeObjectURL(r)})),m?.addEventListener("click",(()=>u.click())),u?.addEventListener("change",(function(){const e=this.files[0];if(!e)return;const t=new FileReader;t.onload=e=>{try{const t=JSON.parse(e.target.result);if(!Array.isArray(t))throw new Error("Invalid JSON");const n=E();n&&n.remove(),v.setItem("tableData",t),H()}catch(e){console.error("Import JSON error:",e),alert("Invalid JSON file!")}},t.readAsText(e)}));const q=e=>{e.nodeType||(e=document.getElementById(e));const t=(e=>(Array.from(e.rows).forEach((e=>{Array.from(e.cells).forEach((e=>{const t=e.textContent.trim().toLowerCase();["remove","<",">"].includes(t)?e.remove():(e.setAttribute("valign","top"),e.classList.contains("selected")&&e.setAttribute("bgcolor","#777777"),"count"===e.dataset.control&&e.setAttribute("bgcolor","#eeeeee"))}))})),e))(e.cloneNode(!0)),n={worksheet:c||"Worksheet",table:t.innerHTML},r=document.createElement("a");var l;r.download=f(c.value||"worksheet","xls"),r.href="data:application/vnd.ms-excel;base64,"+(e=>{const t=(new TextEncoder).encode(e);return btoa(String.fromCharCode(...t))})((l=n,'\n    <html xmlns:o="urn:schemas-microsoft-com:office:office"\n    xmlns:x="urn:schemas-microsoft-com:office:excel"\n    xmlns="http://www.w3.org/TR/REC-html40">\n    <head>\n    \x3c!--[if gte mso 9]>\n    <xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>\n    <x:Name>{worksheet}</x:Name>\n    <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>\n    </x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml>\n    <![endif]--\x3e\n    <meta charset="UTF-8"/>\n    </head><body><table border="1" style="border-collapse:collapse;">{table}</table></body></html>'.replace(/{(\w+)}/g,((e,t)=>l[t])))),r.click()};r?.addEventListener("click",(()=>q("table"))),["C1","C2","C3","C4","C5"].forEach((e=>{const t=document.getElementById(e);if(!t)return;const n=t=>{t?.preventDefault(),o.value=e.toUpperCase()};t.addEventListener("click",n);const r=t.closest("label");r&&r.addEventListener("click",(e=>{e.preventDefault(),n(),L()})),t.addEventListener("input",L),t.addEventListener("change",L)})),document.addEventListener("DOMContentLoaded",(()=>{const e=v.getItem("tableData",null);e&&Array.isArray(e)&&e.length>0?H():C(Number(l.value)||31,c.value||h),(()=>{const e=E();e&&e.addEventListener("contextmenu",(e=>{const t=e.target.closest("td");if(!t)return;const n=t.parentElement.querySelectorAll("td");t.cellIndex>=n.length-4||(e.preventDefault(),t.innerHTML="",t.classList.remove("selected"),delete t.dataset.breakAdded,L())}))})()})),t?.addEventListener("click",(()=>{C(Number(l.value)||31,c.value||h)})),n?.addEventListener("click",(()=>{const e=E();if(!e)return;const t=e.getElementsByTagName("tr");if(!t.length)return;const n=t[t.length-1].cloneNode(!0),r=n.querySelectorAll("td");for(let e=0;e<r.length;e++){const t=r[e];if(0===e){t.addEventListener("dblclick",I);continue}if(e<r.length-4){t.addEventListener("click",A),t.addEventListener("dblclick",I);continue}const n=(t.textContent||"").trim();"remove"===n?t.addEventListener("click",N):">"===n?t.addEventListener("click",T):"<"===n&&t.addEventListener("click",w)}e.appendChild(n),L()})),a?.addEventListener("click",(()=>{const t=e.querySelectorAll(".selected");t.length&&t.forEach((e=>S(e,o.value,s.checked)))})),i?.addEventListener("click",(()=>{L(),M()}));const $=(e,t,n)=>{const r=Number(e),l=Number(t)||1,a=Math.max((e.toString().split(".")[1]||"").length,(t.toString().split(".")[1]||"").length);return Number(("inc"===n?r+l:r-l).toFixed(a))},B={min:0,max:100,step:0,value:0,set number(e){"number"==typeof e&&(e>this.max||e<this.min||(this.value=e))},get number(){return this.value}};Object.seal(B);let F=!1;const O=document.querySelectorAll('input[type="number"]');async function D(e){F||(F=!0,e?.classList?.add("saved"),await g(500),(()=>{const e=Array.from(O,(e=>e.value));v.setItem("counterValues",e)})(),e?.classList?.remove("saved"),F=!1)}const U=async e=>{e.classList.add("max"),await g(200),e.classList.remove("max")},W=e=>{const t=e.target;if("BUTTON"!==t.tagName)return;const n=t.parentElement.querySelector('input[type="number"]');if(n){if(B.number=parseFloat(n.value),B.step=parseFloat(n.step)||.1,"â€”"===t.textContent){const e=$(n.value,n.step||B.step,"dec");if(!(e>=(parseFloat(n.min)||B.min)))return U(t);n.value=e}if("+"===t.textContent){const e=$(n.value,n.step||B.step,"inc");if(!(e<=(parseFloat(n.max)||B.max)))return U(t);n.value=e}D(t.parentElement)}},j=e=>{const t=e.target;let n=parseFloat(t.value);const r=parseFloat(t.min)||B.min,l=parseFloat(t.max)||B.max;(isNaN(n)||n<r)&&(n=r),n>l&&(n=l);const a=parseFloat(t.step)||B.step,s=Math.max((a.toString().split(".")[1]||"").length,(n.toString().split(".")[1]||"").length);t.value=Number(n.toFixed(s)),D(t.parentElement)},R=v.getItem("counterValues",[]);O.forEach(((e,t)=>{e.value=R&&void 0!==R[t]?R[t]:e.value||e.min||.1,e.parentElement?.addEventListener("click",W),e.addEventListener("change",j)}))})();
